
---
# =====================================
# å®‰è£… docker-rollout é›¶åœæœºéƒ¨ç½²å·¥å…·
# https://github.com/wowu/docker-rollout
# =====================================

- name: æ£€æŸ¥ docker-rollout æ˜¯å¦å·²å®‰è£…
  stat:
    path: ~/.docker/cli-plugins/docker-rollout
  register: docker_rollout_check
  become_user: "{{ deploy_user | default('deploy') }}"
  tags: [docker-rollout, check]

- name: æ˜¾ç¤ºå½“å‰å®‰è£…çŠ¶æ€
  debug:
    msg: "docker-rollout çŠ¶æ€: {{ 'Already installed âœ“' if docker_rollout_check.stat.exists else 'Not installed, will install' }}"
  tags: [docker-rollout, info]

- name: å®‰è£… docker-rollout
  block:
    - name: åˆ›å»º Docker CLI æ’ä»¶ç›®å½•
      file:
        path: ~/.docker/cli-plugins
        state: directory
        mode: '0755'
      become_user: "{{ deploy_user | default('deploy') }}"

    - name: ä¸‹è½½ docker-rollout è„šæœ¬
      get_url:
        url: https://raw.githubusercontent.com/wowu/docker-rollout/main/docker-rollout
        dest: ~/.docker/cli-plugins/docker-rollout
        mode: '0755'
        timeout: 30
      become_user: "{{ deploy_user | default('deploy') }}"
      register: download_result

    - name: éªŒè¯ docker-rollout å®‰è£…
      command: docker rollout --help
      register: rollout_help
      changed_when: false
      become_user: "{{ deploy_user | default('deploy') }}"

    - name: æ˜¾ç¤ºå®‰è£…æˆåŠŸä¿¡æ¯
      debug:
        msg:
          - "docker-rollout å®‰è£…æˆåŠŸï¼"
          - "ç‰ˆæœ¬ä¿¡æ¯: {{ rollout_help.stdout_lines[0] | default('docker-rollout CLI plugin') }}"
          - "ä½¿ç”¨æ–¹æ³•: docker rollout <service-name>"

  when: not docker_rollout_check.stat.exists
  tags: [docker-rollout, install]

- name: æ›´æ–° docker-rolloutï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰
  block:
    - name: è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
      command: docker rollout --help
      register: current_version
      changed_when: false
      become_user: "{{ deploy_user | default('deploy') }}"

    - name: ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
      get_url:
        url: https://raw.githubusercontent.com/wowu/docker-rollout/main/docker-rollout
        dest: ~/.docker/cli-plugins/docker-rollout
        mode: '0755'
        timeout: 30
        force: yes
      become_user: "{{ deploy_user | default('deploy') }}"
      when: docker_rollout_force_update | default(false) | bool

    - name: éªŒè¯æ›´æ–°åçš„ç‰ˆæœ¬
      command: docker rollout --help
      register: updated_version
      changed_when: false
      become_user: "{{ deploy_user | default('deploy') }}"
      when: docker_rollout_force_update | default(false) | bool

    - name: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
      debug:
        msg: "docker-rollout å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: {{ current_version.stdout_lines[0] | default('docker-rollout CLI plugin') }}"
      when: not (docker_rollout_force_update | default(false) | bool)

  when: docker_rollout_check.stat.exists
  tags: [docker-rollout, update]

- name: åˆ›å»ºè„šæœ¬ç›®å½•
  file:
    path: "{{ docker_services_base_dir | default('/opt/services') }}/scripts"
    state: directory
    owner: "{{ deploy_user | default('deploy') }}"
    group: "{{ deploy_user | default('deploy') }}"
    mode: '0755'
  tags: [docker-rollout, scripts]

- name: åˆ›å»º docker-rollout ä½¿ç”¨ç¤ºä¾‹è„šæœ¬
  template:
    src: docker-rollout-example.sh.j2
    dest: "{{ docker_services_base_dir | default('/opt/services') }}/scripts/rollout-example.sh"
    owner: "{{ deploy_user | default('deploy') }}"
    group: "{{ deploy_user | default('deploy') }}"
    mode: '0755'
  tags: [docker-rollout, scripts]

- name: éªŒè¯ docker-rollout åŠŸèƒ½
  block:
    - name: æµ‹è¯• docker-rollout å‘½ä»¤
      command: docker rollout --help
      register: final_test
      changed_when: false
      become_user: "{{ deploy_user | default('deploy') }}"

    - name: æ˜¾ç¤ºæœ€ç»ˆéªŒè¯ç»“æœ
      debug:
        msg:
          - "âœ… docker-rollout å®‰è£…éªŒè¯æˆåŠŸ"
          - "ğŸš€ ç°åœ¨å¯ä»¥ä½¿ç”¨é›¶åœæœºéƒ¨ç½²äº†"
          - "ç¤ºä¾‹ç”¨æ³•:"
          - "  docker rollout web"
          - "  docker rollout -f docker-compose.yml --timeout 60 api"
          - "ğŸ“ è¯¦ç»†æ–‡æ¡£: https://github.com/wowu/docker-rollout"

  rescue:
    - name: å®‰è£…å¤±è´¥å¤„ç†
      debug:
        msg:
          - "âŒ docker-rollout å®‰è£…æˆ–éªŒè¯å¤±è´¥"
          - "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæƒé™"
          - "æ‰‹åŠ¨å®‰è£…å‘½ä»¤:"
          - "  mkdir -p ~/.docker/cli-plugins"
          - "  curl -o ~/.docker/cli-plugins/docker-rollout https://raw.githubusercontent.com/wowu/docker-rollout/main/docker-rollout"
          - "  chmod +x ~/.docker/cli-plugins/docker-rollout"

  tags: [docker-rollout, verify]
